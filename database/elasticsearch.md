# ElasticSearch

- å…¨æ–‡æœç´¢å¼•æ“ï¼Œå¼€æº 
- javaå¼€å‘çš„ï¼Œæ ¸å¿ƒæ˜¯Lucene.jaråŒ…
- ç™¾åº¦ã€è°·æ­Œã€GitHubéƒ½åœ¨ç”¨çš„æœç´¢å¼•æ“
- åªæ”¯æŒjsonæ•°æ®æ ¼å¼
- Restfulé£æ ¼æš´éœ²å‡ºæ¥çš„API
- å¯¹æ ‡Solrï¼š
  - solrå®‰è£…éƒ¨ç½²éº»çƒ¦ï¼ŒESè§£å‹å³å¯ï¼ˆéœ€è¦jdkç¯å¢ƒï¼‰
  - solråœ¨æ•°æ®é‡ä¸Šæ¥åï¼Œæ€§èƒ½ä¸è¡Œï¼ŒESç®¡ç†GitHubåƒäº¿è¡Œä»£ç 
  - ESå¤©ç”Ÿæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
  - solrå¯ä»¥æ”¯æŒxmlç­‰å„ç§ç„¶å¹¶åµçš„æ•°æ®æ ¼å¼



## åŸºç¡€ä»‹ç»

- æœåŠ¡ç«¯å£9200ï¼Œå¯åˆ°webç½‘é¡µæŸ¥çœ‹å½“å‰ESçš„configï¼š

  ```
  http://localhost:9200/
  ```

- ä¸‰å‰‘å®¢ELKä¹‹ä¸€

  - ElasticSearch
  - Logstatch - æ—¥å¿—æ”¶é›†
  - Kibana - web UIï¼Œé«˜çº§çš„ESæŸ¥è¯¢å·¥å…·

- [elasticsearch-head](https://github.com/mobz/elasticsearch-head)æ˜¯å…¶ç®€å•çš„å¯è§†åŒ–webç•Œé¢ï¼ˆéœ€è¦nodejsç¯å¢ƒï¼‰
  > npm i && npm i -g grunt && npm run start

  - open web: http://localhost:9100/
  - æ·»åŠ elasticsearch.ymlé…ç½®é¡¹ä»¥æ”¯æŒè·¨åŸŸè®¿é—®ï¼š

    ```yml
    ...
    http.cors.enabled: true
    http.cors.allow-origin: "*"
    ```
    
  - é‡å¯ES

- å°±æŠŠESå½“åšä¸€ä¸ªæ•°æ®åº“ï¼Œç´¢å¼•å°±æ˜¯ä¸€ä¸ªåº“ï¼Œæ–‡æ¡£å°±æ˜¯åº“ä¸­çš„æ•°æ®

- ç›®å½•ç»“æ„

  ```
  bin å¯åŠ¨æ–‡ä»¶
  config é…ç½®æ–‡ä»¶
  	log4j2	æ—¥å¿—é…ç½®æ–‡ä»¶
  	jvm.options	java è™šæ‹Ÿæœºç›¸å…³çš„é…ç½®
  	elasticsearch.yml		elasticsearchçš„é…ç½®æ–‡ä»¶ï¼é»˜è®¤9200ç«¯å£ï¼è·¨åŸŸï¼
  lib		ç›¸å…³jaråŒ…
  logs	æ—¥å¿—ï¼
  modules	åŠŸèƒ½æ¨¡å—
  plugins	æ’ä»¶ï¼
  ```



## ESæ ¸å¿ƒæ¦‚å¿µ

ç´¢å¼•ã€å­—æ®µç±»å‹ã€æ–‡æ¡£

- _indexç´¢å¼•å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“
- æ–‡æ¡£å°±æ˜¯åº“ä¸­çš„æ•°æ®
- ç±»å‹å°±æ˜¯ä¸€ä¸ªæ•°æ®è¡¨ - 7.xå·²ç»æ²¡æœ‰äº†
- _scoreæ˜¯ä¸ªæƒé‡
- headerå½“åšæ•°æ®å±•ç¤ºå·¥å…·ï¼ŒkibanaåšæŸ¥è¯¢å·¥å…·
- ESæ˜¯ä¸€ä¸ªåŸºäºLuceneã€åˆ†å¸ƒå¼ã€é€šè¿‡Restfulæ–¹å¼è¿›è¡Œäº¤äº’çš„è¿‘å®æ—¶æœç´¢å¹³å°æ¡†æ¶ï¼

| Relation DB     | Elasticsearch  |
| --------------- | -------------- |
| æ•°æ®åº“ database | ç´¢å¼• indices   |
| è¡¨ tables       | ç±»å‹ types     |
| è¡Œ rows         | æ–‡æ¡£ documents |
| å­—æ®µ columns    | å­—æ®µ fields    |

- esæ˜¯é¢å‘æ–‡æ¡£ï¼Œä¸€åˆ‡éƒ½æ˜¯jsonï¼
- esé›†ç¾¤ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç´¢å¼•ï¼ˆæ•°æ®åº“ï¼‰ï¼Œæ¯ä¸ªç´¢å¼•ä¸­å¯ä»¥åŒ…å«å¤šä¸ªç±»å‹ï¼ˆè¡¨ï¼‰ï¼Œæ¯ä¸ªç±»å‹ä¸‹åˆåŒ…å«å¤šä¸ªæ–‡æ¡£ï¼ˆè¡Œï¼‰ï¼Œæ¯ä¸ªæ–‡æ¡£ä¸­åˆåŒ…å«å¤šä¸ªå­—æ®µï¼ˆåˆ—ï¼‰
- ç±»ä¼¼æ˜¯æ–‡æ¡£çš„é€»è¾‘å®¹å™¨ï¼Œå°±åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·ï¼Œè¡¨æ ¼æ˜¯è¡Œçš„å®¹å™¨ã€‚ç±»å‹ä¸­å¯¹äºå­—æ®µçš„å®šä¹‰ç§°ä¸ºæ˜ å°„ï¼Œæ¯”å¦‚nameæ˜ å°„ä¸ºå­—ç¬¦ä¸²ç±»å‹



### ç‰©ç†èŠ‚ç‚¹å’Œåˆ†ç‰‡å¦‚ä½•å·¥ä½œ

ä¸€ä¸ªé›†ç¾¤è‡³å°‘æœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªelasticsearchè¿›ç¨‹ï¼ŒèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•é»˜è®¤çš„ï¼Œå¦‚æœä½ åˆ›å»ºç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼•å°†ä¼šæœ‰5ä¸ªåˆ†ç‰‡ï¼ˆprimary shardï¼Œåˆç§°ä¸ºä¸»åˆ†ç‰‡ï¼‰ï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡ä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼ˆreplica shardï¼Œåˆç§°å¤åˆ¶åˆ†ç‰‡ï¼‰

![image-20210110174857443](./pictures/es-cluster.png)

ä¸Šå›¾ä¾‹å¦‚æœ‰3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå¯ä»¥çœ‹åˆ°ä¸»åˆ†ç‰‡å’Œå¯¹åº”çš„å¤åˆ¶åˆ†ç‰‡éƒ½ä¸ä¼šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹å†…ï¼Œè¿™æ ·æœ‰åˆ©äºæŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

ä¸€ä¸ªåˆ†ç‰‡å°±æ˜¯ä¸€ä¸ªLuceneçš„ç´¢å¼•ï¼Œä¸€ä¸ªåŒ…å«**å€’æ’ç´¢å¼•**çš„æ–‡ä»¶ç›®å½•ã€‚å€’æ’ç´¢å¼•çš„ç»“æ„ä½¿å¾—elasticsearchåœ¨ä¸æ‰«æå…¨éƒ¨æ–‡æ¡£çš„æƒ…å†µä¸‹ï¼Œå°±èƒ½å‘Šè¯‰ä½ å“ªäº›æ–‡æ¡£åŒ…å«ç‰¹å®šçš„å…³é”®è¯ã€‚

#### å€’æ’ç´¢å¼•

elasticsearchä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºå€’æ’ç´¢å¼•çš„ç»“æ„ï¼Œé‡‡ç”¨Luceneå€’æ’ç´¢ä½œä¸ºåº•å±‚ã€‚è¿™ç§ç»“æ„é€‚ç”¨äºå¿«é€Ÿçš„å…¨æ–‡æœç´¢ï¼Œä¸€ä¸ªç´¢å¼•ç”±æ–‡æ¡£ä¸­æ‰€æœ‰ä¸é‡å¤çš„åˆ—è¡¨æ„æˆï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯ã€‚ã€‚ã€‚



### ç‰©ç†è®¾è®¡ï¼š

elasticsearchåœ¨åå¤´æŠŠ**æ¯ä¸ªç´¢å¼•åˆ’åˆ†æˆå¤šä¸ªåˆ†ç‰‡**ï¼Œæ¯ä¸ªåˆ†ç‰‡å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä¸åŒæœåŠ¡å™¨å‡è¿ç§»

### é€»è¾‘è®¾è®¡ï¼š



## Logstash

æ˜¯ELKçš„ä¸­å¤®æ•°æ®æµå¼•æ“ï¼Œç”¨äºä»ä¸åŒç›®æ ‡ï¼ˆæ–‡ä»¶ã€æ•°æ®å­˜å‚¨ã€MQç­‰ï¼‰æ”¶é›†çš„ä¸åŒæ ¼å¼æ•°æ®ï¼Œç»è¿‡è¿‡æ»¤åæ”¯æŒè¾“å‡ºåˆ°ä¸åŒç›®çš„åœ°ï¼ˆæ–‡ä»¶ã€MQã€redisã€elasticsearchã€kafakç­‰ï¼‰ã€‚



## Kibana

Kibanaå¯ä»¥å°†elasticsearchçš„æ•°æ®é€šè¿‡å‹å¥½çš„webé¡µé¢å±•ç¤ºå‡ºæ¥ï¼Œæä¾›å®æ—¶åˆ†æçš„åŠŸèƒ½ã€‚

kibanaé¡µé¢ä¸­æœ‰ä¸ªğŸ”§ï¼Œæ˜¯å¼€å‘å·¥å…·ï¼Œç±»ä¼¼postmançš„åŠŸèƒ½ï¼

**æ±‰åŒ–**: ä¿®æ”¹ `kibana/config/kibana.yml`ï¼Œé‡å¯ç”Ÿæ•ˆã€‚

> i18n.locale: "zh-CN"



## IKåˆ†è¯å™¨æ’ä»¶

åˆ†è¯ï¼šæŠŠä¸€æ®µä¸­æ–‡æˆ–è€…åˆ«çš„åˆ’åˆ†æˆä¸€ä¸ªä¸ªå…³é”®è¯ï¼Œå³åˆ†æˆä¸€ä¸ªä¸ªçš„å…³é”®è¯

ä¸­æ–‡åˆ†è¯å™¨IKåˆ†è¯å™¨æä¾›ä¸¤ä¸ªåˆ†è¯ç®—æ³•ï¼š

1. ik_smartï¼šæœ€å°‘åˆ‡åˆ†
2. ik_max_wordï¼šæœ€ç»†ç²’åº¦åˆ’åˆ†

### å®‰è£…

1. ä¸‹è½½elasticsearch-ik: https://github.com/medcl/elasticsearch-analysis-ik

2. åœ¨elasticsearchçš„pluginsç›®å½•ä¸­å»ºç«‹ä¸€ä¸ªikç›®å½•ï¼Œå…¨éƒ¨æ”¾å…¥ikç›®å½•å³å¯ï¼ 

3. é‡å¯ESï¼Œä¼šçœ‹åˆ°æ—¥å¿—ï¼š

   > ... loaded module [x-pack-wathcer]
   >
   > ... loaded plugin [analysis-ik]
   >
   > ...

4. æŸ¥çœ‹å½“å‰å·²æœ‰çš„æ’ä»¶ï¼šåœ¨ESçš„binç›®å½•ä¸­æ‰§è¡Œå‘½ä»¤ï¼š

   ```powershell
   elasticsearch-plugin list
   ik
   ```

5. ä½¿ç”¨æ¼”ç¤ºï¼š

   æ‰“å¼€kibanaåˆ°consoleé¡µé¢ï¼šhttp://localhost:5601/app/kibana#/dev_tools/console

   ![image-20210110202002657](./pictures/kibana-ik.png)

6. æ›´æ–°é…ç½®åˆ†è¯åº“ï¼š`plugins/ik/config/IKAnalyzer.cfg.xml`ï¼Œå¢åŠ ä¸€ä¸ª**xxx.dic**ï¼Œå¹¶é…ç½®åˆ°xmlä¸­ï¼Œé‡å¯esåº”ç”¨ç”Ÿæ•ˆ



## Resté£æ ¼æ“ä½œ

![image-20210110203142608](/Users/apple/wikis/database/pictures/rest-style.png)



```json
# åˆ›å»ºä¸€ä¸ªæ–‡æ¡£
PUT /test1/type1/1 # 7.xç‰ˆæœ¬ä»¥åï¼Œtype1é»˜è®¤æ˜¯_docï¼ä¸”ESä¸æ¨èè®¾ç½®typeNameäº†
{
  "name": "gzc",
  "age": 22
}
# æ‰§è¡Œç»“æœ
{
  "_index": "test1",
  "_type": "type1",
  "_id": "1",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 0,
  "_primary_term": 1
}
```



PUTå®Œæˆåï¼Œä¼šè‡ªåŠ¨å¢åŠ äº†ç´¢å¼•ï¼åœ¨https://www.elastic.co/guideä¸Šå¯ä»¥æŸ¥çœ‹example:

```json
# åˆ›å»ºä¸€ä¸ªindexæ•°æ®åº“
PUT /my_index
{
	"mappings": {
    "properties": {
      "name": {
        "type": "text"
      },
      "age": {
        "type": "long"
      }
    }
  }	
}

# æ‰§è¡Œç»“æœ
{
  "acknowledged": true,
  "shards_acknowledged": true,
  "index": "my_index"
}
```

è·å–ESçš„å¾ˆå¤šä¿¡æ¯ï¼ˆå‘½ä»¤åœ¨kibanaä¸­ä¼šæœ‰è‡ªåŠ¨æç¤ºï¼‰ï¼š

> GET _cat/indices?v

POSTå¦‚æœä¸ä¼ å€¼ï¼Œå°±ä¼šå…¨éƒ¨è¦†ç›–ï¼ç±»åŒMongoDBã€‚ 

å¤æ‚æŸ¥è¯¢ï¼š

```json
GET test1/user/_search/?q=name:leo

GET test1/user/_search
{ # æŸ¥è¯¢çš„å‚æ•°ä½“
	"query": {
    "match": {
      "name": "gzc"
    }
  },
	"_source": ["name", "age"], // filterè¿‡æ»¤å­—æ®µ
	"sort": [{
    "age": {
      "order": "desc" // æœ‰äº†æ­¤å­—æ®µåï¼Œscoreå°±ä¸ºnulläº†
    }
  }],
	"from": 0, // åˆ†é¡µ ç±»åŒskip æ­¤å¤„ç­‰ä»·äº /search/{current}/{pagesize}
	"size": 2, // è¦å¤šå°‘ä¸ªï¼ŒpageSizeï¼Œåªè¦2ä¸ªï¼Œç±»åŒlimit 
}

# æ‰§è¡Œç»“æœ
hits:
ç´¢å¼•å’Œæ–‡æ¡£çš„ä¿¡æ¯
æŸ¥è¯¢çš„ç»“æœæ€»æ•°
æŸ¥è¯¢å¤„ç†çš„å…·ä½“çš„æ–‡æ¡£ï¼ŒåŒ…æ‹¬äº†_scoreå­—æ®µï¼Œè¡¨ç¤ºåŒ¹é…çš„æƒé‡ï¼
```



æŒ‰boolæ¡ä»¶è¿”å›çš„æŸ¥è¯¢ï¼š

```json
GET test1/user/_search
{
  "query": {
    "bool": { // ç»“æœè¿”å›trueçš„
      "must": [ // éƒ½è¦æ»¡è¶³çš„å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œmustç›¸å½“äºandã€‚å¦å¤–ï¼Œshouldç›¸å½“äºorï¼Œmust_notç›¸å½“äºnot
        {
          "match": {
            "name": "gzc"
          }
        },
        {
          "match": {
            "age": 22
          }
        }
      ],
      "filter": { // ç»“æœé›†ä¸­çš„è¿‡æ»¤æ¡ä»¶ï¼
        "range": { // èŒƒå›´æŸ¥è¯¢
          "age": {
            "gte": 10,
            "lte": 20
          }
        }
      }
    }
  }
}
```



æ•°ç»„ç±»å‹çš„åˆ†è¯å™¨æŸ¥è¯¢

```json
GET test1/user/_search
{ # æŸ¥è¯¢çš„å‚æ•°ä½“
	"query": {
    "match": { # ä¼šä½¿ç”¨åˆ†è¯å™¨
 			"tags": "ç”· æŠ€æœ¯" //tagsåŸå§‹["ç›´ç”·", "æŠ€æœ¯ç‹‚çƒ­è€…", "ç¯®çƒçˆ±å¥½è€…"], æ­¤ç©ºæ ¼åˆ†éš”çš„æ¡ä»¶ç›¸å½“äºç™¾åº¦ä¸­çš„å…³é”®è¯æœç´¢
		}
	}
}
```

**ç²¾ç¡®æŸ¥æ‰¾ term**

ä¼šä½¿ç”¨å€’æ’ç´¢å¼•åšç²¾ç¡®æŸ¥æ‰¾

```json
GET _analyze
{
  "analyzer": "keyword", // ä¸ä¼šè¢«åˆ†è¯
  "text": "gzcçˆ±å­¦ä¹ "
}

GET _analyze
{
  "analyzer": "standard", // ä¼šè¢«åˆ†è¯è§£æ
  "text": "gzcçˆ±å­¦ä¹ "
}

GET testdb/_search
{
  "query": {
    "term": { // ç²¾ç¡®æŸ¥æ‰¾
      â€name": "g"
    }
  }
}

# ç²¾ç¡®æŸ¥è¯¢å¤šä¸ªå€¼
GET testdb/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "term": {
            "t1": "22"
          }
        },
        {
          "term": {
            "t1": "33"
          }
        }
      ]
    }
  }
}
```



### é«˜äº®æŸ¥è¯¢

```json
GET testdb/user/_search
{
  "query": {
    "match": {
      "name": "gzc"
    }
  },
  "highlight": { // é«˜äº®
    "fields": {
      "pre_tags": "<p clas='key' style='color:red'>", // è‡ªå®šä¹‰é«˜äº®æ¡ä»¶ï¼é»˜è®¤æ˜¯<em>
      "post_tags": "</p>", // åŸé»˜è®¤æ˜¯</em>
      "name": {}
    }
  }
}

# æ‰§è¡Œç»“æœ

```



### æ•°æ®ç±»å‹

- å­—ç¬¦ä¸²ç±»å‹ï¼štextã€keywordï¼Œå…¶ä¸­texç±»å‹tæ˜¯å¯è¢«åˆ†è¯å™¨å¤„ç†çš„ï¼Œkeywordè¡¨ç¤ºæœ€å°é›†äº†ï¼Œä¸å¯å†è¢«åˆ†è¯
- æ•°å€¼ç±»å‹ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€half floatã€scaled float
- æ—¥æœŸç±»å‹ï¼šdate
- å¸ƒå°”å€¼ç±»å‹ï¼šBoolen
- äºŒçº§åˆ¶ç±»å‹ï¼šbinary



## å‚è€ƒèµ„æ–™

- [ã€ç‹‚ç¥è¯´Javaã€‘ElasticSearch7.6.xæœ€æ–°å®Œæ•´æ•™ç¨‹](https://www.bilibili.com/video/BV17a4y1x7zq?t=852&p=1)
- [ç‹‚ç¥è¯´ç¬”è®°](https://gitee.com/kuangstudy/openclass)
- [å¤æ‚ESæŸ¥è¯¢](https://www.bilibili.com/video/BV17a4y1x7zq?p=11)

